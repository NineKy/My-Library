# Day 11

## ì„¸ì…˜ ì €ì¥ì†Œë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©í•˜ê¸°

### ì§€ê¸ˆê¹Œì§€ì˜ ë¬¸ì œ

*   í˜„ì¬ê¹Œì§€ì˜ ì„œë¹„ìŠ¤ëŠ” ì•±ì„ ì¬ì‹¤í–‰í•˜ê²Œ ë˜ë©´ ë¡œê·¸ì¸ì´ í’€ë¦¼ â‡’ ì„¸ì…˜ì´ ë‚´ì¥ í†°ìº£ì˜ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ê¸° ë•Œë¬¸

    \= ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ë‹¤ ë³´ë‹ˆ ë‚´ì¥ í†°ìº£ì²˜ëŸ¼ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ ì‹¤í–‰ë˜ëŠ” êµ¬ì¡°ì—ì„  í•­ìƒ ì´ˆê¸°í™”ë¨

    \= ë°°í¬í•  ë•Œë§ˆë‹¤ í†°ìº£ì´ ì¬ì‹œì‘
*   ë§Œì•½ 2ëŒ€ ì´ìƒì˜ ì„œë²„ì—ì„œ ì„œë¹„ìŠ¤í•˜ê³  ìˆë‹¤ë©´ í†°ìº£ë§ˆë‹¤ ì„¸ì…˜ì˜ ë™ê¸°í™”ê°€ í•„ìš”í•¨

    \= ì„¸ì…˜ ì €ì¥ì†Œì— ëŒ€í•´ ë°©ë²• 3ê°€ì§€

    * í†°ìº£ ì„¸ì…˜ì„ ì‚¬ìš©
      * ì¼ë°˜ì ìœ¼ë¡œ ë³„ ë‹¤ë¥¸ ì„¤ì •ì´ ì—†ì„ë•Œ ê¸°ë³¸ì ìœ¼ë¡œ ì„ íƒë˜ëŠ” ë°©ì‹
      * í†°ìº£(WAS)ì— ì„¸ì…˜ì´ ì €ì¥ë˜ê¸° ë•Œë¬¸ì— 2ëŒ€ ì´ìƒì˜ WASê°€ êµ¬ë™ë˜ëŠ” í™˜ê²½ì—ì„œëŠ” í†°ìº£ë“¤ ê°„ì˜ ì„¸ì…˜ ê³µìœ ë¥¼ ìœ„í•œ ì¶”ê°€ ì„¤ì •ì´ í•„ìš”
    * MySQLê³¼ ê°™ì€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„¸ì…˜ ì €ì¥ì†Œë¡œ ì‚¬ìš©
      * ì—¬ëŸ¬ WAS ê°„ì˜ ê³µìš© ì„¸ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°€ì¥ ì‰¬ìš´ ë°©ë²•
      * ë§ì€ ì„¤ì •ì´ í•„ìš” ì—†ì§€ë§Œ, ê²°êµ­ ë¡œê·¸ì¸ ìš”ì²­ë§ˆë‹¤ DB IOê°€ ë°œìƒí•˜ì—¬ ì„±ëŠ¥ìƒ ì´ìŠˆê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ
      * ë³´í†µ ë¡œê·¸ì¸ ìš”ì²­ì´ ë§ì´ ì—†ëŠ” ë°±ì˜¤í”¼ìŠ¤, ì‚¬ë‚´ ì‹œìŠ¤í…œ ìš©ë„ì—ì„œ ì‚¬ìš©
    * Redis, Memcachedì™€ ê°™ì€ ë©”ëª¨ë¦¬ DBë¥¼ ì„¸ì…˜ ì €ì¥ì†Œë¡œ ì‚¬ìš©
      * B2C ì„œë¹„ìŠ¤ì—ì„œ ê°€ì¥ ë§ì´ ì‚¬ìš©í•˜ëŠ” ë°©ì‹
      * ì‹¤ì œ ì„œë¹„ìŠ¤ë¡œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” Embedded Redisì™€ ê°™ì€ ë°©ì‹ì´ ì•„ë‹Œ ì™¸ë¶€ ë©”ëª¨ë¦¬ ì„œë²„ê°€ í•„ìš”

### 2ë²ˆì§¸ ë°©ì‹ì¸ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì„¸ì…˜ ì €ì¥ì†Œë¡œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì„ ì±„íƒ

ğŸ‘‰ ì´ìœ  : ì„¤ì •ì´ ê°„ë‹¨, ì‚¬ìš©ìê°€ ë§ì€ ì„œë¹„ìŠ¤ê°€ ì•„ë‹ˆë©° ë¹„ìš©ì ˆê°ì„ ìœ„í•´ì„œ

\+Redisì™€ ê°™ì€ ë©”ëª¨ë¦¬ DBëŠ” awsì‚¬ìš©ì‹œ ë”°ë¡œ ì‚¬ìš©ë£Œë¥¼ ì§€ë¶ˆí•˜ë©´ì„œ ì‚¬ìš©í•´ì•¼í•¨

### spring-session-jdbc ë“±ë¡

build.gradleì— ì˜ì¡´ì„±ì„ ë“±ë¡

build.gradle

```java
compile('org.springframework.session:spring-session-jdbc')
```

application-properties

```java
spring.session.store-type=jdbc
```

ì„¤ì •ì„ ë§ˆì³¤ìœ¼ë‹ˆê¹Œ h2-consoleë¡œ ì ‘ì†í•´ì„œ ì„¸ì…˜ì„ ìœ„í•œ í…Œì´ë¸”(SPRING\_SESSION, SPRING\_SESSION\_ATTRIBUTES)ê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸

â†’ JPAë¡œ ì¸í•´ ì„¸ì…˜ í…Œì´ë¸”ì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆê¸° ë•Œë¬¸ì— ë”±íˆ í• ì¼ì€ ì—†ìŒ

ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìŠ¤í”„ë§ì„ ì¬ì‹œì‘í•˜ë©´ ì„¸ì…˜ì´ í’€ë¦°ë‹¤ â†’ h2ë„ ì¬ì‹œì‘ë˜ê¸° ë•Œë¬¸ì„

* í•˜ì§€ë§Œ awsì— ì—…ë¡œë“œí•˜ê²Œ ë˜ë©´ rdsë¡œ ë°”ë€Œë‹ˆê¹Œ ì„¸ì…˜ì´ ì•ˆí’€ë¦°ë‹¤

### ë„¤ì´ë²„ ë¡œê·¸ì¸ ì¶”ê°€

ë„¤ì´ë²„ APIë¡œ ì´ë™í•´ì„œ https://developers.naver.com/apps/#register?api=nvlogin

ì‚¬ìš©í•˜ê³ 

[application-oauth.properties](http://application-oauth.properties)ì— ì¶”ê°€

[application-oauth.properties](http://application-oauth.properties)

```java
#registration
spring.security.oauth2.client.registration.naver.client-id = í´ë¼ì´ì–¸íŠ¸ID
spring.security.oauth2.client.registration.naver.client-secret = í´ë¼ì´ì–¸íŠ¸pw
spring.security.oauth2.client.registration.naver.redirect-uri={baseUrl}/{action}/oauth2/code/{registrationId}
spring.security.oauth2.client.registration.naver.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.naver.scope=name, email, profile_image
spring.security.oauth2.client.registration.naver.client-name = Naver

#provider
spring.security.oauth2.client.provider.naver.authorization-uri=https://nid.naver.com/oauth2.0/authorize
spring.security.oauth2.client.provider.naver.token-uri=https://nid.naver.com/oauth2.0/token
spring.security.oauth2.client.provider.naver.user-info-uri=https://openapi.naver.com/v1/nid/me
spring.security.oauth2.client.provider.naver.user_name_attribute=response
```

* user\_name\_attribute = response
  * ê¸°ì¤€ì´ ë˜ëŠ” user\_nameì˜ ì´ë¦„ì„ ë„¤ì´ë²„ì—ì„œëŠ” responseë¡œ í•´ì•¼í•œë‹¤
  * ì´ìœ ëŠ” ë„¤ì´ë²„ì˜ íšŒì› ì¡°íšŒ ì‹œ ë°˜í™˜ë˜ëŠ” JSON í˜•íƒœ

\-ë„¤ì´ë²„ì˜ ì‘ë‹µê°’ ìµœìƒìœ„ í•„ë“œëŠ” resultCode, messge, responseì´ë‹¤

ê·¸ë ‡ê¸° ë•Œë¬¸ì— ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ì—ì„œ ì¸ì‹ì´ ê°€ëŠ¥í•œ í•„ë“œëŠ” ì € 3ê°œì¤‘ì— í•˜ë‚˜ì—¬ì•¼í•œë‹¤

* ë³¸ë¬¸ì—ì„œ ë‹´ê³  ìˆëŠ” responseë¥¼ user\_nameìœ¼ë¡œ ì§€ì •
* ì´í›„ë¡œ ìë°” ì½”ë“œë¡œ responseì˜ idë¥¼ user\_nameìœ¼ë¡œ ì§€ì •

### ìŠ¤í”„ë§ ì‹œíë¦¬í‹° ì„¤ì • ë“±ë¡

OAuthAttributesì— ë„¤ì´ë²„ì¸ì§€ íŒë‹¨í•˜ëŠ” ì½”ë“œì™€ ë„¤ì´ë²„ ìƒì„±ìë¥¼ ì¶”ê°€

src/main/java/com/kyu/book/springboot/config/auth/dto/OAuthAttributes

```java
public static OAuthAttributes of(String registrationId, String userNameAttributeName, Map<String, Object> attributes){
        if("naver".equals(registrationId)){
            return ofNaver("id", attributes);
        }
        return ofGoogle(userNameAttributeName, attributes);
    }

    private static OAuthAttributes ofNaver(String userNameAttributeName, Map<String, Object> attributes){
        Map<String, Object> response = (Map<String, Object>) attributes.get("response");
        return OAuthAttributes.builder()
                .name((String)response.get("name"))
                .email((String)response.get("email"))
                .picture((String)response.get("profile_image"))
                .attributes(response)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }
```

* ì—¬ê¸°ì„œ

index.mustacheì— ë„¤ì´ë²„ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ì¶”ê°€

src/main/java/resource/template/index.mustache

```html
...

{{^userName}}
    <a href="/oauth2/authorization/google" class="btn btn-success active" role="button">Google Login</a>
    <a href="/oauth2/authorization/naver" class="btn btn-success active" role="button">Naver Login</a>
{{/userName}}

...
```

* /oauth2/authorization/naver
  * ë„¤ì´ë²„ ë¡œê·¸ì¸ URLì€ application-oauth.propertiesì— ë“±ë¡í•œ redirect-url ê°’ì— ë§ì¶°ì„œ ìë™ìœ¼ë¡œ ë“±ë¡
  * /oauth2/authorization ê¹Œì§€ëŠ” ê³ ì •ì´ê³  ë§ˆì§€ë§‰ pathë§Œ ê° ì†Œì…œ ë¡œê·¸ì¸ ì½”ë“œë¥¼ ì‚¬ìš©
