# Day 13

### AWS(Amazon Web Service)라는 클라우드 서비스 사용 <a href="b616f438-1db6-48dc-89d1-519ad55b248d" id="b616f438-1db6-48dc-89d1-519ad55b248d"></a>

외부에서 본인이 만든 서비스에 접근하기 위해서는 24시간 작동하는 서버가 필요함

* 집에서 PC를 24시간 구동시키거나
* 호스팅 서비스(Cafe 24, 코리아호스팅 등)을 사용
* 클라우드 서비스(AWS, AZURE, GCP 등)을 이용

일반적으로 비용은 호스팅 서비스나 집 PC를 사용하는 것이 저렴

하지만 트래픽이 몰리는 시간대가 있다면 → **유동적으로 사용을 늘릴 수 있는 클라우드가 유리함**

#### 클라우드 서비스 <a href="567c1118-9235-4d64-a85b-7fefda49f127" id="567c1118-9235-4d64-a85b-7fefda49f127"></a>

* 인터넷(클라우드)를 통해 서버, 스토리지, 데이터베이스, 네트워크, 소프트웨어, 모니터링 등의 컴퓨팅 서비스를 제공하는 것
* 예를 들어서, AWS의 EC2는 서버 장비를 대여하는 것이지만 실제로는 그 안의 로그 관리, 모니터링, 하드웨어 교체, 네트워크 관리 등을 기본적으로 지원(개발자가 직접 해야 할 일을 AWS가 전부 지원함)
* 형태
  * Infrastructure as a Service(IaaS, 아이아스, 이에스)
    * 기존 물리 장비를 미들웨어와 함께 묶어둔 추상화 서비스
    * 가상머신, 스토리지, 네트워크, 운영체제 등의 IT 인프라를 대여해 주는 서비스
    * AWS의 EC2, S3등
  * Platform as a Service(Paas, 파스)
    * IaaS에서 한 번 더 추상화한 서비스
    * 한 번 더 추상화 했기 때문에 많은 기능이 자동화되어 있음
    * AWS의 Beanstalk(빈스톡), Herokyu(헤로쿠) 등
  * Software as a Service(SaaS, 사스)
    * 소프트웨어 서비스를 의미함
    * 구글 드라이브, 드랍박스, 와탭 등

이 책에서 진행하는 모든 AWS서비스는 IaaS를 사용한다

AWS의 Paas인 빈스톡을 사용하게되면 대부분의 작업이 간소화되지만 프리티어로 무중단배포가 불가능

### console.aws.amazon.com으로 들어가서 로그인 <a href="955bc40b-87a1-4ab1-9784-08ef33797353" id="955bc40b-87a1-4ab1-9784-08ef33797353"></a>

#### EC2 인스턴스 생성 <a href="454763b6-fec1-4c0a-90bd-c2dcad2a9229" id="454763b6-fec1-4c0a-90bd-c2dcad2a9229"></a>

EC2(Elastic Compute Cloud)는 AWS에서 제공하는 성능, 용량 등을 유동적으로 사용할 수 있는 서버

보통 AWS에서 리눅스 서버 혹은 윈도우 서버를 사용합니다 = EC2를의미함

AWS에서 무료로 제공하는 프리티어 플랜에서는 EC2 사용에 제한이 있음

* 사양이 t2.micro만 가능
  * vCPU(가상 cpu) 1 Core, 메모리 1GB 사양
  * 보통은 vCPU는 물리 CPU 사양의 절반정도의 성능
* 월 750시간의 제한이 있고 초과하게되면 비용이 부과됨
  * 24시간 \* 31일 = 744시간
  * 즉, 1대의 t2.micro만 사용한다면 24시간 사용할 수 있음

일단 **리전이 서울인지 확인하고 안되어있으면 서울로 변경**

#### 1. 인스턴스 시작 <a href="37f88e52-ba8e-4654-8a20-3987fc000856" id="37f88e52-ba8e-4654-8a20-3987fc000856"></a>

검색창에서 EC2를 검색

인스턴스를 생성하는 첫 단계는 AMI(Amazon Machine Image)를 설정하는 것

* AMI은 EC2 인스턴스를 시작하는데 필요한 정보를 이미지로 만들어 둔 것을 의미

#### 2. AMI에서 Amazon Linux AMI을 선택 <a href="f884ccfc-7e91-41d7-aae6-3ccbba46ab0b" id="f884ccfc-7e91-41d7-aae6-3ccbba46ab0b"></a>

(Amazon Linux AMI2가 아님)

1을 선택한 이유는 국내 자료 기준으로는 자료가 리눅스 1이 더 많음

⇒ 하지만 실제로 들어가서 확인해본 결과 Amazon Linux AMI2밖에 없으니까 이걸로하장

#### 3. 다음은 인스턴스 유형을 선택 <a href="0d99a7b4-e9ce-40f6-b2fa-3da0f96a9605" id="0d99a7b4-e9ce-40f6-b2fa-3da0f96a9605"></a>

프리티어로 표기되어 있는 t2.micro를 선택

\*t2와 t3가 있는데 이들을 T시리즈로 하고 범용 시리즈로 불리기도 한며 다양한 사양을 사용할 수 있음

이들은 다른 서비스와 달리 크레딧이란 일종의 CPU를 사용할 수 있는 포인트 개념이 있다. 인스턴스의 크기에 따라 정해진 비율로 CPU크레딧을 계속 받게 되며, 사용하지 않을 때는 크레딧을 축적하고, 사용할 때 이 크레딧을 사용

정해진 사양보다 더 높은 트래픽이 오면 크레딧을 좀 더 적극적으로 사용하면서 트래픽을 처리하지만, 크레딧이 모두 사용되면 더 이상 EC2를 사용할 수 없음

#### 4. 인스턴스 세부 정보 구성 <a href="897d4657-0c80-4929-a4ce-808b02d8a4a9" id="897d4657-0c80-4929-a4ce-808b02d8a4a9"></a>

화면상에 표기된 VPC, 서브넷등을 세세하게 다루지만

**혼자서 하기 때문에 별 다른 설정없이 넘어감**

#### 5. 스토리지 추가 <a href="5d58aabd-ce2d-46da-b667-df01b30dbadb" id="5d58aabd-ce2d-46da-b667-df01b30dbadb"></a>

스토리지는 우리가 흔히 생각하는 하드디스크를 이야기하며, 서버의 용량을 얼마나 정할지 선택하는 단계

* 기본으로 8GB가 선택되어있지만
* 최대 30GB까지 프리티어로 가능하다

#### 6. 태그 추가 <a href="51dfdd7e-7aec-4b61-acd2-42b9eda28f05" id="51dfdd7e-7aec-4b61-acd2-42b9eda28f05"></a>

* 태그에는 웹 콘솔에 표기될 태그인 Name 태그를 등록
* 태그는 해당 인스턴스를 표현하는 여러 이름으로 사용될 수 있음(EC2에 이름을 붙힌다)

여러 인스턴스가 있을 경우, 태그별로 구분하면 검색이나 그룹짓기 편함

⇒ 여기서 본인 서비스의 인스턴스를 나타낼 수 있는 값으로 등록

#### 7. 보안 그룹 구성 <a href="1725ce1d-895c-42fa-be37-55c6fd3a1e06" id="1725ce1d-895c-42fa-be37-55c6fd3a1e06"></a>

* 보안 그룹이란 방화벽을 의미함
* 서버로 80포트 이외에는 허용하지 않는다는 역할을 하는 방화벽이 AWS에서는 보안 그룹으로 사용됨

기존에 생성해둔 보안그룹 말고 새로운 유의미한 이름으로 생성하자

유형 / 프로토콜 / 포트 범위 / 소스

SSH / TCP / 22 / 내 IP

(추가) 사용자 지정 TCP / TCP / 8080 / 사용자 지정

(추가) HTTPS / TCP / 443 / 사용자 지정

* SSH이면서 포트 항목에서 22인 경우
  * AWS EC2에 터미널로 접속 할 때를 의미함
  * pem 키 관리와 지정된 IP에서만 ssh 접속이 가능하도록 구성하는 것이 안정
  * 그래서 본인 집의 IP를 기본적으로 추가(내 IP를 선택하면 현재 접속한 장소의 IP가 자동으로 지정)
  * 만약 다른 장소에서 접속해야할 때는 해당 장소의 IP를 다시 SSH 규칙에 추가하는 것을 권장

**이제 시작하기를 마지막으로 세팅을 완료해준다**

#### pem 키 받기 <a href="371a2b3f-cbc6-47c0-915e-e0f44bfadf5b" id="371a2b3f-cbc6-47c0-915e-e0f44bfadf5b"></a>

* 인스턴스로 접근하기 위해서는 pem키(비밀키)가 필요
* 인스턴스는 지정된 pem 키와 매칭되는 공개키를 가지고 있어, 해당 pem 키 외에는 접근을 허용하지 않음
* 일종의 마스터키이기 때문에 유출 절대 안됨
* pem 키는 이후 EC2 서버로 접속할 때 필수 피일이니 잘 관리할 수 있는 디렉토리로 저장

나는 옛날에 생성 해둔 awsleaner 를 사용

#### 끝! 일단 인스턴스를 띄우는데 성공했고, 인스턴스 목록에 방금 생성한 인스턴스가 실행중일 것이며, IP와 도메인이 할당 된 것을 확인할 수 있음 <a href="47cff77a-b1f8-43f5-b24b-04023c8a0e74" id="47cff77a-b1f8-43f5-b24b-04023c8a0e74"></a>

인스턴스도 결국은 하나의 서버이기 때문에 IP가 존재한다

→ 인스턴스의 IP는

* 새롭게 인스턴스를 생성했을 때
* 인스턴스를 중지하고 다시 시작할 떄

이렇게 2가지 경우에 새로운 IP를 할당한다

⇒ 번거롭기 때문에 매번 변경되지 않고 고정된 IP를 가지게 해야함

#### EIP할당 <a href="c4d9fbe7-e88d-4313-8fda-7ce0655e83be" id="c4d9fbe7-e88d-4313-8fda-7ce0655e83be"></a>

* AWS의 고정 IP를 Elastic IP(EIP)라고 함 = 탄력적 IP

탄력적 IP로 들어가서 하나 생성한 후, 해당 페이지에서 작업바를 누르면 주소 연결 메뉴가 있을꺼임 여기서 인스턴스를 선택하고 프라이빗 ip주소를 선택하고 연결한 후

원래 인스턴스로 돌아가서 확인해보면 탄력적 IP 주소에 성공적으로 방금 생성한 주소가 들어가있을 것

#### 탄력적 IP는 생성하고 EC2 서버에 연결하지 않으면 비용이 발생함 <a href="83456379-cf31-4040-9992-16d9987ea43b" id="83456379-cf31-4040-9992-16d9987ea43b"></a>

#### 즉, 생성한 탄력적 IP는 무조건 EC2에 바로 연결해야 하며 만약 더는 사용할 인스턴스가 없을 때도 탄력적 IP를 바로 삭제해야함 ⇒ 비용 청구됨 <a href="62812bba-bec3-4078-8e12-3165cfb224c9" id="62812bba-bec3-4078-8e12-3165cfb224c9"></a>

#### EC2 서버에 접속하기 <a href="0f4299ca-dff3-49de-b40f-652f6ec1fb1c" id="0f4299ca-dff3-49de-b40f-652f6ec1fb1c"></a>

안되면 체크 해야할 것들

* HostName 값이 정확히 탄력적 IP로 되어있는지 확인
* EC2 인스턴스가 running 상태인지 확인
* EC2 인스턴스의 보안 그룹 → 인바운드 규칙에서 현재 본인의 IP가 등록되어 있는지 확인

AWS와 같은 외부 서버로 SSH 접속을 하려면 매번 입력해야하는 명령어가 있음

```
ssh -i pem 키 위치 EC2의 탄력적 IP 주소
```

이렇게까지하면 귀찮으니까 쉽게하는 방법

* 받은 키페어 pem 파일을 \~/.ssh/로 복사
  * \~/ .ssh / 디렉토리로 pem파일을 옮겨둠
  * 이렇게 하면 ssh 실행 시 pem 키 파일을 자동으로 읽어 접속을 진행
  * 이렇게 하면 별도로 pem 키 위치를 명령어로 지정할 필요가 없게 됩니다

1. cp pem 키를 내려받은 위치 \~/.ssh/
   * cp \~/Downloads/awsleaner.pem \~/.ssh/

이렇게 pem키를 다운받은 곳에서 pem파일을 .ssh폴더에 복사

2\. chmod 600 \~/.ssh/pem키이름

* chmod 600 \~/.ssh/awsleaner.pem

이렇게 권한을 변경해주고

3\. 권한을 변경했다면 pem 키가 있는 \~/.ssh 디렉토리에 config파일을 생성

* vim \~/.ssh/config

내용

```
Host freelec-springboot2-webservice
		HostName 54.180.199.9
		User ec2-user
		IdentityFile ~/.ssh/awsleaner.pem
```

\#주석

Host 본인이 원하는 서비스명

HostName ec2의 탄력적 IP주소

User ec2-user

IdentityFile \~/.ssh/pem키 이름

이렇게 파일을 생성했으면 :wq로 저장 종료한 후

4\. chmod 700 \~/.ssh/config

config파일의 실행 권한이 필요하기 때문에 권한 설정을 함

5\. ssh config에 등록한 서비스명

* ssh freelec-springboot2-webservice
* 이렇게 하면 EC2에 접속에 성공!!!!

#### 아마존 리눅스 서버 생성 시 꼭 필요한 설정들 <a href="7e60212c-5ced-418b-9ab2-468a485d0dbe" id="7e60212c-5ced-418b-9ab2-468a485d0dbe"></a>

이 설정들은 모두 자바 기반의 웹 애플리케이션이 작동해야 하는 서버에서는 필수로 필요한 설정

* java 8 설치 : 현재 이 프로젝트의 버전은 Java 8이기 때문
* 타임존 변경 : 기본 서버의 시간은 미국 시간대임. 한국 시간대가 되어야만 우리가 사용하는 시간이 모두 한국 시간으로 등록되고 사용됨
* 호스트네임 변경 : 현재 접속한 서버의 별명을 등록. 실무에서는 한대의 서버가 아닌 수십대의 서버가 작동되는데, IP만으로 어떤 서버가 어떤 역할을 하는지 알 수 없기 때문에 이를 구분하기 위해 보통 호스트 네임을 필수로 등록함

#### JAVA 8 설치 <a href="91501d65-5c64-4075-aceb-ba0156647dba" id="91501d65-5c64-4075-aceb-ba0156647dba"></a>

EC2에서 다음 명령어 실행

```
sudo yum install -y java-1.8.0-openjdk-devel.x86_64
```

이걸로 설치 완료하면

```
sudo /usr/sbin/alternatives --config java
```

로 현재 설치되어있는 jdk를 확인하고

Java7과 Java8이 있다면 2를 입력해서 Java8로 변경

```
sudo yum remove java-1.7.0-openjdk
```

로 사용하지 않는 java7을 삭제하고

```
java -version
```

로 Java 8 이 되어이는지 확인

#### 타임존 변경 <a href="043f16c8-7b6c-4735-bcec-40769764f712" id="043f16c8-7b6c-4735-bcec-40769764f712"></a>

EC2 서버의 기본 타임존은 UTC이고 한국의 시간과는 9시간 차이가 발생하기 때문에 꼭 수정해야함

```
sudo rm /etc/localtime
sudo ln -s /usr/share/zoneinfo/Asia/Seoul /etc/localtime
```

변경후

```
date
```

를 입력해봐서 정상적으로 KST로 변경 되었는지 확인

#### Hostname 변경 <a href="80c5c6b6-7a02-47b4-8756-65eb62933e9a" id="80c5c6b6-7a02-47b4-8756-65eb62933e9a"></a>

여러 서버를 관리 중일 경우 IP만으로 어떤 서비스의 서버인지 확인이 어려움

그래서 각 서버가 어떤 서비스인지 표현하기 위해 HOSTNAME을 변경

```
sudo vim /etc/sysconfig/network
```

여기서 HOSTNAME으로 되어있는 부분을 본인이 원하는 서비스명으로 변경한다

```
HOSTNAME=freelec-springboot2-webservice
```

이렇게 변경 후

```
sudo reboot
```

로 서버를 재부팅 후 EC2에 다시 접속

이 방식이 안되서

[https://aws.amazon.com/ko/premiumsupport/knowledge-center/linux-static-hostname/?nc1=h\_ls](https://aws.amazon.com/ko/premiumsupport/knowledge-center/linux-static-hostname/?nc1=h\_ls)

여기에서 참고해서 변경해봄 → 이걸로 성공

```
sudo vim /etc/hosts
```

로 파일을 열어서 방금등록한 HOSTNAME을 등록

```
127.0.0.1  freelec-springboot2-webservice
```

저장하고 나와서

```
curl 등록한 호스트 이름
```

으로 정상적으로 등록이 되었는지 확인

→ Failed to connect to ...

이렇게 80 포트로 접근이 안 된다는 에러가 발생해야 잘 등록된거임

\=80포트로 실행된 서비스가 없다는 의미
